<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <title>Shop</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

  <div class="coin-display">
    ðŸ’° <span id="coinCount">0</span>
  </div>

  <h1>Welcome to the Shop!</h1>
  <button class="button" onclick="window.location.href='index.html'">Back to Home</button>

  <div class="card-pack-grid">
    <div class="card-slot-container">
      <img src="images/generalist pack.png" class="card-image" alt="Generalist Pack">
      <div class="card-label">Generalist Pack â€“Â 150Â coins</div>
      <button onclick="buyPack('generalist',150)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/debuffer pack.jpg" class="card-image" alt="Debuffer Pack">
      <div class="card-label">Debuffer Pack â€“Â 200Â coins</div>
      <button onclick="buyPack('debuffer',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/mage pack.jpg" class="card-image" alt="Mage Pack">
      <div class="card-label">Mage Pack â€“Â 200Â coins</div>
      <button onclick="buyPack('mage',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/support pack.jpg" class="card-image" alt="Support Pack">
      <div class="card-label">Support Pack â€“Â 200Â coins</div>
      <button onclick="buyPack('support',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/dps pack.jpg" class="card-image" alt="DPS Pack">
      <div class="card-label">DPS Pack â€“Â 200Â coins</div>
      <button onclick="buyPack('dps',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/spirit pack.jpg" class="card-image" alt="Spirit Pack">
      <div class="card-label">Spirit Pack â€“Â 200Â coins</div>
      <button onclick="buyPack('spirit',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/hacker pack.jpg" class="card-image" alt="Hacker Pack">
      <div class="card-label">Hacker Pack â€“Â 200Â coins</div>
      <button onclick="buyPack('hacker',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/specialist pack.jpg" class="card-image" alt="Specialist Pack">
      <div class="card-label">Specialist Pack â€“Â 500Â coins</div>
      <button onclick="buyPack('specialist',500)">Buy</button>
    </div>
  </div>

  <!-- Pack Opening Modal -->
  <div id="pack-opening" class="pack-opening hidden">
    <div class="burst-pack">
      <img id="pack-image" class="pack-image" src="" alt="Pack">
      <p id="click-prompt" class="click-prompt">Click!</p>
      <img id="card-image" class="revealed-card hidden" src="" alt="Card">
    </div>
  </div>

  <script>
    // Firebase Setup
    const firebaseConfig = {
      apiKey: "AIzaSyANtfKFonwEu6ewUS6yNYM8qZBkf2aFcIo",
      authDomain: "card-game-51dd7.firebaseapp.com",
      projectId: "card-game-51dd7",
      storageBucket: "card-game-51dd7.appspot.com",
      messagingSenderId: "1059333480213",
      appId: "1:1059333480213:web:9787cdf5da0242aebf531c",
      databaseURL: "https://card-game-51dd7-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUserId, currentCoins = 0;
    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = 'index.html';
      currentUserId = user.uid;
      db.ref(`users/${currentUserId}/coins`)
        .on('value', snap => {
          currentCoins = snap.val()||0;
          document.getElementById('coinCount').textContent = currentCoins;
        });
    });

    function buyPack(name, cost) {
      if (currentCoins < cost) return alert("Not enough coins!");
      const uref = db.ref(`users/${currentUserId}`);
      uref.transaction(u => {
        if (!u || (u.coins||0) < cost) return u;
        u.coins -= cost;
        u.packs = u.packs||{};
        u.packs[name] = (u.packs[name]||0) + 1;
        return u;
      }).then(() => triggerPackOpening(name));
    }

    function getRandomCardFromSpecialist() {
      const rand = Math.random() * 100;
      let rarity, n;

      if (rand < 75) rarity = 'common';
      else if (rand < 90) rarity = 'rare';
      else if (rand < 96) rarity = 'epic';
      else if (rand < 99.5) rarity = 'legendary';
      else rarity = 'godly';

      if (rarity === 'common')     n = Math.floor(Math.random()*43)+1;
      else if (rarity === 'rare')  n = Math.floor(Math.random()*6)+44;
      else if (rarity === 'epic')  n = Math.floor(Math.random()*6)+50;
      else if (rarity === 'legendary') n = Math.floor(Math.random()*6)+56;
      else                          n = Math.floor(Math.random()*3)+62;

      return {
        path: `images/card-${String(n).padStart(3,'0')}.PNG`,
        rarity
      };
    }

    function triggerPackOpening(name) {
      const modal   = document.getElementById('pack-opening');
      const imgPack = document.getElementById('pack-image');
      const imgCard = document.getElementById('card-image');
      const prompt  = document.getElementById('click-prompt');
      const ext     = name==='generalist'? 'png':'jpg';

      imgCard.className = 'revealed-card hidden';
      imgCard.src = '';
      prompt.textContent = 'Click!';
      imgPack.classList.remove('glowing-pack');

      let draw = { path:'images/card-placeholder.jpg', rarity:'common' };
      if (name==='generalist') {
        draw = getRandomCardFromGeneralist();
      } else if (name === 'specialist') {
        draw = getRandomCardFromSpecialist();
      }

      modal.classList.remove('hidden');
      imgPack.src = `images/${name} pack.${ext}`;

      const isGlowing = ['rare','epic','legendary','godly'].includes(draw.rarity);
      if (isGlowing) imgPack.classList.add('glowing-pack');
      const maxClicks = isGlowing ? 5 : 3;

      let clicks=0, opened=false;

      imgPack.onclick = () => {
        if (opened) return;
        clicks++;
        imgPack.style.transform='scale(1.1)';
        setTimeout(()=> imgPack.style.transform='scale(1)',150);
        if (clicks>=maxClicks) {
          opened = true;
          imgCard.src = draw.path;
          imgCard.classList.remove('hidden');
          imgCard.classList.add('rarity-' + draw.rarity);
          prompt.textContent = draw.rarity!=='common'
            ? `âœ¨ ${draw.rarity.toUpperCase()}! âœ¨` : '';
        }
      };

      modal.onclick = e => {
        if (opened && e.target===modal) {
          modal.classList.add('hidden');
          imgPack.onclick = null;
        }
      };
    }
  </script>

</body>
</html>