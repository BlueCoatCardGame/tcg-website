<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <title>Shop</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

  <div class="coin-display">
    💰 <span id="coinCount">0</span>
  </div>

  <h1>Welcome to the Shop!</h1>
  <button class="button" onclick="window.location.href='index.html'">Back to Home</button>

  <div class="card-pack-grid">
    <div class="card-slot-container">
      <img src="images/generalist pack.png" class="card-image" alt="Generalist Pack">
      <div class="card-label">Generalist Pack – 150 coins</div>
      <button onclick="buyPack('generalist',150)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/debuffer pack.jpg" class="card-image" alt="Debuffer Pack">
      <div class="card-label">Debuffer Pack – 200 coins</div>
      <button onclick="buyPack('debuffer',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/mage pack.jpg" class="card-image" alt="Mage Pack">
      <div class="card-label">Mage Pack – 200 coins</div>
      <button onclick="buyPack('mage',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/support pack.jpg" class="card-image" alt="Support Pack">
      <div class="card-label">Support Pack – 200 coins</div>
      <button onclick="buyPack('support',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/dps pack.jpg" class="card-image" alt="DPS Pack">
      <div class="card-label">DPS Pack – 200 coins</div>
      <button onclick="buyPack('dps',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/spirit pack.jpg" class="card-image" alt="Spirit Pack">
      <div class="card-label">Spirit Pack – 200 coins</div>
      <button onclick="buyPack('spirit',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/hacker pack.jpg" class="card-image" alt="Hacker Pack">
      <div class="card-label">Hacker Pack – 200 coins</div>
      <button onclick="buyPack('hacker',200)">Buy</button>
    </div>
    <div class="card-slot-container">
      <img src="images/specialist pack.jpg" class="card-image" alt="Specialist Pack">
      <div class="card-label">Specialist Pack – 500 coins</div>
      <button onclick="buyPack('specialist',500)">Buy</button>
    </div>
  </div>

  <div id="pack-opening" class="pack-opening hidden">
    <div class="burst-pack">
      <img id="pack-image" class="pack-image" src="" alt="Pack">
      <p id="click-prompt" class="click-prompt">Click!</p>
      <img id="card-image" class="revealed-card hidden" src="" alt="Card">
    </div>
  </div>

  <script>
   // Firebase Setup
const firebaseConfig = {
  apiKey: "AIzaSyANtfKFonwEu6ewUS6yNYM8qZBkf2aFcIo",
  authDomain: "card-game-51dd7.firebaseapp.com",
  projectId: "card-game-51dd7",
  storageBucket: "card-game-51dd7.appspot.com",
  messagingSenderId: "1059333480213",
  appId: "1:1059333480213:web:9787cdf5da0242aebf531c",
  databaseURL: "https://card-game-51dd7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUserId, currentCoins = 0;
auth.onAuthStateChanged(user => {
  if (!user) return window.location.href = 'index.html';
  currentUserId = user.uid;
  db.ref(`users/${currentUserId}/coins`)
    .on('value', snap => {
      currentCoins = snap.val()||0;
      document.getElementById('coinCount').textContent = currentCoins;
    });
});

function buyPack(name, cost) {
  if (currentCoins < cost) return alert("Not enough coins!");
  const uref = db.ref(`users/${currentUserId}`);
  uref.transaction(u => {
    if (!u || (u.coins||0) < cost) return u;
    u.coins -= cost;
    u.packs = u.packs||{};
    u.packs[name] = (u.packs[name]||0) + 1;
    return u;
  }).then(res => {
    if (res && res.committed) triggerPackOpening(name);
  });
}

// Card pools for packs sharing same rarity logic and counts
const packCardPools = {
  debuffer: {
    commons: [1,2,3,4,5,6,7],
    rares: [44],
    epics: [50],
    legendaries: [56]
  },
  mage: {
    commons: [8,9,10,11,12,13,14],
    rares: [45],
    epics: [51],
    legendaries: [57]
  },
  support: {
    commons: [15,16,17,18,19,20,21],
    rares: [46],
    epics: [52],
    legendaries: [58]
  },
  dps: {
    commons: [22,23,24,25,26,27,28],
    rares: [47],
    epics: [53],
    legendaries: [59]
  },
  spirit: {
    commons: [29,30,31,32,33,34,35],
    rares: [48],
    epics: [54],
    legendaries: [60]
  },
  hacker: {
    commons: [36,37,38,39,40,41,42],
    rares: [49],
    epics: [55],
    legendaries: [61]
  }
};

// Packs with different rarity setups remain as before
function getRandomCardFromGeneralist() {
  const rand = Math.random()*100;
  const rarity = rand < 85 ? 'common' :
                 rand < 95 ? 'rare' :
                 rand < 99 ? 'epic' :
                             'legendary';
  let n;
  if (rarity === 'common')    n = Math.floor(Math.random()*43)+1;
  else if (rarity === 'rare') n = Math.floor(Math.random()*6)+44;
  else if (rarity === 'epic') n = Math.floor(Math.random()*6)+50;
  else                         n = Math.floor(Math.random()*6)+56;
  return {
    path: `images/card-${String(n).padStart(3,'0')}.PNG`,
    rarity
  };
}

function getRandomCardFromSpecialist() {
  const rand = Math.random()*100;
  const rarity = rand < 75 ? 'common' :
                 rand < 90 ? 'rare' :
                 rand < 96 ? 'epic' :
                 rand < 99.5 ? 'legendary' :
                               'godly';
  let n;
  if (rarity === 'common')       n = Math.floor(Math.random()*43)+1;
  else if (rarity === 'rare')    n = Math.floor(Math.random()*6)+44;
  else if (rarity === 'epic')    n = Math.floor(Math.random()*6)+50;
  else if (rarity === 'legendary') n = Math.floor(Math.random()*6)+56;
  else                            n = Math.floor(Math.random()*3)+62;
  return {
    path: `images/card-${String(n).padStart(3,'0')}.PNG`,
    rarity
  };
}

function getRandomCardFromDebuffer() {
  // Use the shared packCardPools debuffer to maintain consistency
  return getRandomCardFromPack('debuffer');
}

function getRandomCardFromPack(packName) {
  const pool = packCardPools[packName];
  if (!pool) {
    console.error(`Pack ${packName} not found in card pools.`);
    return { path: '', rarity: 'common' };
  }

  const rand = Math.random() * 100;
  const rarity = rand < 70 ? 'common' :
                 rand < 90 ? 'rare' :
                 rand < 98 ? 'epic' :
                             'legendary';

  let cardNumber;
  switch(rarity) {
    case 'common':
      cardNumber = pool.commons[Math.floor(Math.random() * pool.commons.length)];
      break;
    case 'rare':
      cardNumber = pool.rares[Math.floor(Math.random() * pool.rares.length)];
      break;
    case 'epic':
      cardNumber = pool.epics[Math.floor(Math.random() * pool.epics.length)];
      break;
    case 'legendary':
      cardNumber = pool.legendaries[Math.floor(Math.random() * pool.legendaries.length)];
      break;
    default:
      cardNumber = pool.commons[0];
  }

  return {
    path: `images/card-${String(cardNumber).padStart(3, '0')}.PNG`,
    rarity
  };
}

function triggerPackOpening(name) {
  const modal   = document.getElementById('pack-opening');
  const imgPack = document.getElementById('pack-image');
  const imgCard = document.getElementById('card-image');
  const prompt  = document.getElementById('click-prompt');
  const ext     = name==='generalist'? 'png':'jpg';

  // reset
  imgCard.className = 'revealed-card hidden';
  imgCard.removeAttribute('src');
  prompt.textContent = 'Click!';
  imgPack.classList.remove('glowing-pack','red-glow');

  // choose draw
  let draw = {path:'',rarity:'common'};
  if (name==='generalist')       draw = getRandomCardFromGeneralist();
  else if (name==='specialist')  draw = getRandomCardFromSpecialist();
  else if (name==='debuffer')    draw = getRandomCardFromDebuffer();
  else if (['mage','support','dps','spirit','hacker'].includes(name)) {
    draw = getRandomCardFromPack(name);
  } else {
    console.warn('Unknown pack name:', name);
  }

  console.log('>> REVEALING:', draw.path, draw.rarity);

  // show modal + pack art
  modal.classList.remove('hidden');
  imgPack.src = `images/${name} pack.${ext}`;

  const isSpecialGlow = ['rare','epic','legendary','godly'].includes(draw.rarity);
  if (isSpecialGlow) imgPack.classList.add('glowing-pack');

  const clickLimit = draw.rarity === 'godly' ? 10 : isSpecialGlow ? 5 : 3;

  let clicks = 0, opened = false;
  imgPack.onclick = () => {
    if (opened) return;
    clicks++;
    imgPack.style.transform = 'scale(1.1)';
    setTimeout(() => imgPack.style.transform = 'scale(1)', 150);

    if (clicks >= clickLimit) {
      opened = true;
      imgCard.src = draw.path;
      imgCard.classList.remove('hidden');
      imgCard.classList.add(`rarity-${draw.rarity}`);
      prompt.textContent = draw.rarity !== 'common'
        ? `✨ ${draw.rarity.toUpperCase()}! ✨`
        : '';
    }
  };

  modal.onclick = e => {
    if (opened && e.target === modal) {
      modal.classList.add('hidden');
      imgPack.onclick = null;
    }
  };
}

  modal.onclick = e => {
    if (opened && e.target===modal) {
      modal.classList.add('hidden');
      imgPack.onclick = null;
    }
  };
  </script>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shop 2 – Diamonds</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <style>
    /* Minimal inline adjustments—rest of styling comes from style.css */
    body {
      background-color: #1e1e1e;
      color: white;
      font-family: 'Segoe UI Emoji','Noto Color Emoji','Apple Color Emoji',Arial,sans-serif;
      text-align: center;
      padding: 40px;
    }
    h1 {
      margin-bottom: 24px;
    }
    .currency-display {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .currency-box {
      background-color: #333;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .diamond-section {
      margin-top: 40px;
      border-top: 1px solid #444;
      padding-top: 30px;
    }
    .corrupted-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      max-width: 800px;
      margin: 20px auto;
    }
    .corrupt-card {
      background-color: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
    }
    .corrupt-card img {
      max-width: 100%;
      border-radius: 6px;
    }
    .corrupt-card button {
      margin-top: 8px;
      background-color: #00e5ff;
      border: none;
      border-radius: 6px;
      color: #1e1e1e;
      font-weight: bold;
      padding: 6px 12px;
      cursor: pointer;
    }
    .corrupt-card button:disabled {
      background-color: #555;
      cursor: default;
    }
    .convert-button {
      margin-top: 24px;
      background-color: #ffd600;
      border: none;
      border-radius: 6px;
      color: #1e1e1e;
      font-weight: bold;
      padding: 8px 16px;
      cursor: pointer;
    }
    .convert-button:disabled {
      background-color: #555;
      cursor: default;
    }
  </style>
</head>
<body>

  <h1>Shop 2 – Diamonds</h1>

  <div class="currency-display">
    <div class="currency-box">
      💰 <span id="coinCount">0</span>
    </div>
    <div class="currency-box">
      💎 <span id="diamondCount">0</span>
    </div>
  </div>

  <!-- Diamond → Coin Converter -->
  <button id="convertBtn" class="convert-button" disabled>
    Convert 1 💎 → 100 coins
  </button>

  <!-- Corrupted Cards Section -->
  <div class="diamond-section">
    <h2>Corrupted Cards (Costs 25 💎 each)</h2>
    <div class="corrupted-grid" id="corruptGrid">
      <!-- Six cards (065–070) will be injected here -->
    </div>
  </div>

  <script>
    // ─── Firebase Initialization ───
    // Firebase is already initialized above; reuse the existing app, auth, and db.
    // const firebaseConfig = { ... };
    // firebase.initializeApp(firebaseConfig);
    // const auth = firebase.auth();
    // const db   = firebase.database();

    currentUserId = null;
    let coinCountElem = document.getElementById("coinCount");
    let diamondCountElem = document.getElementById("diamondCount");
    let convertBtn = document.getElementById("convertBtn");
    let corruptGrid = document.getElementById("corruptGrid");

    // As soon as the user is logged in, load their coins + diamonds
    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("Please log in first.");
        window.location.href = "index.html";
        return;
      }
      currentUserId = user.uid;

      // Listen to 'coins' and 'diamonds' in realtime
      const userRef = db.ref(`users/${currentUserId}`);
      userRef.on("value", snapshot => {
        const data = snapshot.val() || {};
        const coins = data.coins || 0;
        const diamonds = data.diamonds || 0;

        coinCountElem.textContent = coins;
        diamondCountElem.textContent = diamonds;

        // Enable/disable the converter button
        convertBtn.disabled = (diamonds < 1);
        // Also re‐render the corrupt cards' buy buttons
        renderCorruptedCards(diamonds);
      });
    });

    // ─── Convert 1 💎 → 100 coins ───
    convertBtn.addEventListener("click", () => {
      const userRef = db.ref(`users/${currentUserId}`);
      userRef.transaction(userData => {
        if (!userData) return userData;
        userData.diamonds = (userData.diamonds || 0) - 1;
        userData.coins    = (userData.coins    || 0) + 100;
        return userData;
      });
    });

    // ─── Corrupted Cards (065–070) Setup ───
    // We’ll keep an array of those six card IDs:
    const corruptedCardIDs = ["065","066","067","068","069","070"];
    // Each costs 25 💎
    const corruptCost = 25;

    function renderCorruptedCards(currentDiamonds) {
      // Clear previous
      corruptGrid.innerHTML = "";

      corruptedCardIDs.forEach(id => {
        const cardDiv = document.createElement("div");
        cardDiv.classList.add("corrupt-card");

        // Image tag
        const img = document.createElement("img");
        img.src = `images/card-${id}.PNG`;
        img.alt = `Corrupted Card ${id}`;
        cardDiv.appendChild(img);

        // “Buy for 25 💎” button
        const btn = document.createElement("button");
        btn.textContent = `Buy for ${corruptCost} 💎`;
        // Disable if not enough diamonds
        btn.disabled = (currentDiamonds < corruptCost);
        btn.addEventListener("click", () => {
          buyCorruptedCard(id);
        });
        cardDiv.appendChild(btn);

        corruptGrid.appendChild(cardDiv);
      });
    }

    function buyCorruptedCard(cardID) {
      const userRef = db.ref(`users/${currentUserId}`);
      userRef.transaction(userData => {
        if (!userData) return userData;
        const diamonds = userData.diamonds || 0;
        if (diamonds < corruptCost) {
          return; // abort if not enough
        }
        userData.diamonds = diamonds - corruptCost;
        // You can push this cardID into a “corruptedOwned” list:
        userData.corruptedOwned = userData.corruptedOwned || [];
        if (!userData.corruptedOwned.includes(cardID)) {
          userData.corruptedOwned.push(cardID);
        }
        return userData;
      }).then(() => {
        alert(`You successfully purchased corrupted card ${cardID}!`);
      });
    }
  </script>
</body>
</html>
</body>
</html>