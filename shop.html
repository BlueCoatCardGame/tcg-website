<script>
  const firebaseConfig = {
    apiKey: "AIzaSyANtfKFonwEu6ewUS6yNYM8qZBkf2aFcIo",
    authDomain: "card-game-51dd7.firebaseapp.com",
    projectId: "card-game-51dd7",
    storageBucket: "card-game-51dd7.appspot.com",
    messagingSenderId: "1059333480213",
    appId: "1:1059333480213:web:9787cdf5da0242aebf531c",
    databaseURL: "https://card-game-51dd7-default-rtdb.firebaseio.com"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUserId = null;
  let currentCoins = 0;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUserId = user.uid;
      const coinsRef = db.ref(`users/${currentUserId}/coins`);
      coinsRef.on('value', snapshot => {
        currentCoins = snapshot.val() ?? 0;
        document.getElementById('coinCount').textContent = currentCoins;
      });
    } else {
      alert("You must be logged in to view the shop.");
      window.location.href = 'index.html';
    }
  });

  function buyPack(packName, packCost) {
    if (currentCoins < packCost) {
      alert("Not enough coins!");
      return;
    }

    const userRef = db.ref(`users/${currentUserId}`);

    userRef.transaction(userData => {
      if (userData) {
        if ((userData.coins ?? 0) >= packCost) {
          userData.coins -= packCost;
          userData.packs = userData.packs || {};
          userData.packs[packName] = (userData.packs[packName] || 0) + 1;
          return userData;
        } else {
          // Abort transaction: not enough coins
          return;
        }
      }
      return userData;
    }, (error, committed, snapshot) => {
      if (error) {
        console.error("Transaction failed abnormally!", error);
        alert("Something went wrong. Please try again.");
      } else if (!committed) {
        alert("Not enough coins!");
      } else {
        // Success! Open the pack
        triggerPackOpening(packName);
      }
    });
  }

  function triggerPackOpening(packName) {
    const packOpening = document.getElementById('pack-opening');
    const packImage = document.getElementById('pack-image');
    const cardImage = document.getElementById('card-image');

    // Fix pack image extension issues explicitly
    const formattedName = packName.toLowerCase();
    const packExt = (formattedName === 'generalist') ? 'png' : 'jpg';

    packImage.src = `images/${formattedName} pack.${packExt}`;
    cardImage.src = 'images/card-placeholder.jpg';

    // Reset UI
    cardImage.classList.add('hidden');
    packImage.style.cursor = 'pointer';

    let clicksNeeded = 3;
    let clicksDone = 0;

    packOpening.classList.remove('hidden');

    // Remove any previous click handler to avoid stacking
    packImage.onclick = () => {
      clicksDone++;
      if (clicksDone < clicksNeeded) {
        // Optional subtle feedback
        packImage.style.transform = 'scale(1.1)';
        setTimeout(() => {
          packImage.style.transform = 'scale(1)';
        }, 150);
      } else {
        // Reveal the card on last click
        cardImage.classList.remove('hidden');
        packImage.style.cursor = 'default';
        packImage.onclick = null;
      }
    };

    // Close modal on clicking outside images
    packOpening.onclick = (e) => {
      if (e.target === packOpening) {
        packOpening.classList.add('hidden');
        packImage.onclick = null;
        packOpening.onclick = null;
      }
    };
  }
</script>